(function(t,n){if(typeof define==="function"&&define.amd){define([],n)}else if(typeof module==="object"&&module.exports){module.exports=n()}else{t.Jroff=n()}})(this,function(){var t={TH:function(t,n){var e;t=m(t);n.title=t[0]||"";n.section=t[1]||"";n.date=t[2]||"";n.source=t[3]||"";n.manual=t[4]||"";e=n.title+"("+n.section+")";return"<p><span>"+e+"</span>"+"<span>"+n.manual+"</span>"+"<span>"+e+"</span></p>"},SH:function(t){return v("h2",t)},SS:function(t){return v("h3",t)},B:function(t){return v("strong",t)},BI:function(t){return g("strong","i",t)},BR:function(t){return g("strong","span",t)},I:function(t){return v("i",t)},IB:function(t){return g("i","strong",t)},IR:function(t){return g("i","span",t)},RB:function(t){return g("span","strong",t)},RI:function(t){return g("span","i",t)},SB:function(t){g("small","strong",t)},SM:function(t){v("small",t)},P:function(t){v("p",t)}};t.LP=t.P;t.PP=t.P;var n={Dt:function(t,n){var i,o;t=m(t);n.title=t[0]||"UNTITLED";n.section=t[1]||1;n.volume=t[2]||"";i=n.title+"("+n.section+")";o=e[n.section];return"<p><span>"+i+"</span>"+"<span>"+o+"</span>"+"<span>"+i+"</span></p>"},Dd:function(t,n){n.date=t;return""},Os:function(t,n){n.os=t;return""},Ad:function(t){return v("i",t)},An:function(t){return v("span, args")},Ar:function(t){t=t||"file...";return v("i",t)},Cd:function(t){return v("strong",t)},Dv:function(t){return t},Ev:function(t){return t},Fl:function(t){return v("strong","-"+t)},Cm:function(t){return v("strong",t)},Nm:function(t,n){var e;n.name=n.name||t;e=t||n.name;return v("strong",e)},Nd:function(t){return v("span","-- "+t)},Sh:function(t){return v("h2",t)},Op:function(t){return v("span","["+t+"]")},Xr:function(t){var n,e,i;t=m(t);n=t[0]||"";e=t[1]?"("+t[1]+")":"";i=t[3];return v("span",n+e)}};var e={1:"BSD General Commands Manual",2:"BSD System Calls Manual",3:"BSD Library Functions Manual",4:"BSD Kernel Interfaces Manual",5:"BSD File Formats Manual",6:"BSD Games Manual",7:"BSD Miscellaneous Information Manual",8:"BSD System Manager's Manual",9:"BSD Kernel Developer's Manual"};var i=function(t,n){this.value=t||"";this.kind=n||l;this.nodes=[]};i.isComment=function(t){return d.comment.test(t)};i.isEmptyLine=function(t){return t==="\n"};i.isInlineMacro=function(t){return Boolean(y[t])};i.isMacro=function(t){return d.macro.test(t)};i.prototype.addNode=function(t){this.nodes.push(t);return this};i.prototype.addSubNode=function(t){this.lastNode().addNode(t)};i.prototype.lastNode=function(){return this.nodes[this.nodes.length-1]||new i};i.prototype.mix=function(t){this.value=this.value+" "+t.value;if(this.kind===l){this.kind=t.kind}return this};i.prototype.mixWithLastNode=function(t){this.lastNode().mix(t);return this};var o=function(){};o.prototype.create=function(t){var n=h;if(typeof t==="undefined"){n=l}else if(i.isComment(t)){n=u}else if(i.isMacro(t)){n=c;t=t.substring(1)}else if(i.isInlineMacro(t)){n=p}else if(i.isEmptyLine(t)){n=f}return new i(t,n)};var a=function(t){this.source=t.match(d.noWithespace);this.tokens=[];this.sourceIdx=0;this.col=0;this.line=1;this.factory=new o};a.prototype.lex=function(){var t;while(t=this.next()){this.tokens.push(this.factory.create(t))}return this.tokens};a.prototype.next=function(){var t=this.source[this.sourceIdx++];if(t==="\n"){this.col=0;this.line+=1}else if(t){this.col+=t.length}return t};var s=function(t){this.ast=[];this.lexer=new a(t);this.tokens=this.lexer.lex();this.tokenslen=this.tokens.length;this.idx=0;this.state=f;this.buffer={};var n=[{state:u,input:"*",action:"ignore"},{state:u,input:f,action:"stop"},{state:c,input:f,action:"stop"},{state:c,input:h,action:"addText"},{state:c,input:p,action:"addInline"},{state:c,input:u,action:"ignore"},{state:c,input:c,action:"addText"},{state:p,input:h,action:"addImacro"},{state:p,input:p,action:"addImacro"},{state:p,input:u,action:"ignore"},{state:p,input:"*",action:"defaultError"},{state:f,input:c,action:"startMacro"},{state:f,input:f,action:"addLineBreak"},{state:f,input:h,action:"startText"},{state:f,input:"*",action:"cleanBreak"},{state:h,input:c,action:"concatenate"},{state:h,input:u,action:"ignore"},{state:h,input:h,action:"concatenate"},{state:h,input:f,action:"stop"}];this.initMappings=function(){var t,e;for(var i=n.length-1;i>=0;i--){t=n[i];e=t.state+"-"+t.input;if(!this[t.action]){throw"Undefined function "+t.action+" in Parser object"}this[e]=this[t.action].bind(this)}};this.lastTok=function(){return this.ast[this.ast.length-1]};this.initMappings()};s.prototype.addImacro=function(t){this.state=c;this.lastTok().addSubNode(t)};s.prototype.addInline=function(t){this.state=p;this.lastTok().addNode(t)};s.prototype.addLineBreak=function(t){this.ast.push(t)};s.prototype.addText=function(t){var n=this.lastTok();if(n.lastNode().kind===h){n.mixWithLastNode(t)}else{n.addNode(t)}};s.prototype.buildAST=function(){var t,n,e;while(this.tokenslen>this.idx){t=this.tokens[this.idx];n=this.state+"-"+t.kind;e=this[n]||this[this.state+"-*"];if(!e){throw"Cannot find a function named "+n+" or "+this.state+"-*"}e(t);this.idx++}return this.ast};s.prototype.cleanBreak=function(t){this.state=t.kind};s.prototype.concatenate=function(t){this.lastTok().mix(t)};s.prototype.defaultError=function(t){throw"Error parsing argument with state: "+this.state+", input: "+t.kind};s.prototype.ignore=function(){this.state=u};s.prototype.startMacro=function(t){this.state=c;this.ast.push(t)};s.prototype.startText=function(t){this.state=h;this.ast.push(t)};s.prototype.stop=function(t){this.state=f};var r=function(t){var n={};return t.reduce(function(t,e){if(e.kind===c||e.kind===p){var i=y[e.value]||function(){console.warn("warn: undefined macro "+e.value);return e.value};t+=e.nodes.length?i(r(e.nodes),n):i(null,n)}else{t+=e.value}return t},"")};var u=1,c=2,p=3,f=4,h=5,l=6;var d={macro:/^\./,noWithespace:/\n|\S+/g,comment:/(\.\\)?\\\"/,arguments:/"(.*?)"|\S+/g};var m=function(t){t=t.match(d.arguments)||[];return t.map(function(t){return t.replace(/\"/g,"")})};var v=function(t,n,e){var i=t.split(">"),o=-1,a="",s="";while(i[++o]){a+="<"+i[o]+">"}while(i[--o]){s+=" </"+i[o]+">"}return a+n+s};var g=function(t,n,e){var i=-1,o="",a=n;e=m(e);while(e[++i]){a=a===t?n:t;o+=v(a,e[i])}return o};var y=n;return{Lexer:a,Token:i,TokenFactory:o,macros:y,anMacros:t,patterns:d,Parser:s,debug:r,COMMENT:u,MACRO:c,IMACRO:p,BREAK:f,TEXT:h,EMPTY:l}});
