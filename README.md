![jroff](https://cloud.githubusercontent.com/assets/4419992/11488319/61d7086e-97a4-11e5-9ea7-2276c409c208.png)

![travis](https://travis-ci.org/roperzh/jroff.svg?branch=master)
[![Code Climate](https://codeclimate.com/github/roperzh/jroff/badges/gpa.svg)](https://codeclimate.com/github/roperzh/jroff)
[![Test Coverage](https://codeclimate.com/github/roperzh/jroff/badges/coverage.svg)](https://codeclimate.com/github/roperzh/jroff/coverage)

## About

*For a real-life example, check out [grapse](http://www.roperzh.com/grapse).*

Jroff is a man page parser written in JavaScript, with:

- Partial support for groff native commands
- Full support for `an` macros
- Full support for `doc` macros

The main funcionality of the library is to produce an
[AST](https://en.wikipedia.org/wiki/Abstract_syntax_tree) ready to
be consumed by a generator.

At the moment only an HTML generator is implemented, but the plan is
to include multiple generators in the near future.

## Usage
*The annotated version of the code can be found [here](http://www.roperzh.com/jroff/)*

### HTML Generator
The usage of the generator is fairly simple, you just need to create
a new instance of the generator and call the `generate` method every
time you want to parse a string containing groff text.

The `generate`function takes two arguments; the source string and an
optional name of the macro library that will be used to parse the result:


```javascript
// Instantiate a new generator
var generator = new Jroff.HTMLGenerator();
// Generate the HTML output
var result = generator.generate('.Op Fl 0 Ns Op Ar octal', 'doc');
```
Then, if we print the result variable:

```html
<span> [ <strong> - 0  <span> [ <i>  octal </i>] </span> </strong>] </span>
```

### Parser

The parser takes a string as a source and is capable to build an AST
from it, the usage is very straithforward and nearly
useless without a generator:

```javascript
// Instantiate a new parser class
var parser = new Jroff.Parser('.Op Fl lorem ipsum');
// Build the AST
var ast = parser.buildAST();
```
If we inspect the `ast` variable:

```json
[{
  "value": "Op",
  "kind": 2,
  "nodes": [{
    "value": " ",
    "kind": 5,
    "nodes": []
  }, {
    "value": "Fl",
    "kind": 3,
    "nodes": [{
      "value": " lorem ipsum",
      "kind": 5,
      "nodes": []
    }]
  }]
}]
```

### Defining new macros

If you need to define a specific macro for your project, you can do it
adding a new item in the `Jroff.macros.defaults` object, using
the macro name as a key and the function with specific macro
functionality as the value:

```javascript
Jroff.macros.defaults.sp = function (spacing) {
    spacing = spacing || '2';
    return '<hr style="margin-top:' + spacing + 'em;visibility:hidden;">';
};
```
Internally all the macros are defined like this, so you can check out `src/macros/defaults.js` for more examples.

## Contributing

For regular development, you need to have `Node.js >=0.10` installed on
your system, then:

Clone the repository

```console
git clone git@bitbucket.org:roperzh/jroff_final.git
cd jroff_final
```

Install the required dependencies

```console
npm install
```

Build your local copy and run the tests:

```console
make all
```

### Brief explanation of the code organization

`dist`: This folder stores bundled versions of the code.

`src/core`: As the folder name says, this is the core of the library.
There is no HTML-related code here, only code to parse and build the AST.

`src/generators`: Generators are entities capables of consume the AST
generated by the parser and produce an output. For the moment only an HTML
generator is implemented.

`src/macros`: Implementations of macro commands and macro packages.
For the moment the only packages supported ar `an` and `doc`.
Macros supported by groff are stored in `default.js`.

`src/utils`: Utility functions and general stuff.

### Brief explanation of make commands

***make dist:*** beautify and build minified and concatenated versions
of the code.

***make hint:*** run [js-hint](http://jshint.com/) over the test files
and the concatenated non-minified version of the code.

***make beautify:*** run [js-beautify](https://github.com/beautify-web/js-beautify)
over all the JavaScript files.

***make doc:*** build a local documentation based on the current version
of the code, useful to preview the documentation before pushing.
Check the next section for more details.

### Documenting new code

This library uses [jsdoc3](https://github.com/jsdoc3/jsdoc) to generate
the documentation, so all the new code must be documented using jsdoc
tags. An useful reference can be found [here](http://usejsdoc.org/index.html).

Also, due to [limitations](https://github.com/jsdoc3/jsdoc/issues/930) with
jsdoc and UMD it is required to add the `@alias` tag to all functions,
constructors and namespaces.

### Generating the documentation

The Makefile includes an useful command to generate and push the
documentation to GitHub and GitHub pages, you can simply run:

```console
make doc-build
```

**Note:** please make sure to stash or commit all your changes
before building the documentation.

If you want to preview the changes before pushing, you can generate
the documentation with the `doc` task and then and open `docs/index.html`
in your browser.

This is an example using OS X:

```console
make doc
open docs/index.html
```

### Benchmarks

Running benchmarks is complicated, and even more complicated in this specific
case since there aren't other libraries to use as a reference and compare
the results.

In consequence the idea of this benchmarks is to compare different versions
of the library against three arbitrary man pages: `Git`, `Node.js`
and `Ruby`.

This benchmark should be used only as an estimative comparation between
versions or complex features.

If you want to run the benchmarks and compare with the latest stored results:

```console
make bench
```

Alternatively you can store the results of the current benchmark in the
cache file (`benchmarks/benchmarks.json`) with the `-s` flag:

```console
make bench flags='-s'
```
### TODOs

- [ ] Add support for nested numeric lists
- [ ] Add support for `-width` arguments in lists
- [ ] Add missing macros

### Links

- [About macros](http://www.schweikhardt.net/man_page_howto.html#q5)
- [About the `an` macro](http://linux.die.net/man/7/man)
- [About the `doc` macro](https://www.dragonflybsd.org/cgi/web-man?command=mdoc&section=7)
- [Troff spec](http://cm.bell-labs.com/sys/doc/troff.pdf)

## License

All the code contained in this repository, unless explicitly stated, is
licensed under MIT license.

A copy of the license can be found inside the [LICENSE](LICENSE) file.
